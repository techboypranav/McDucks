<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Portal - LogiTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-slate-900 min-h-screen text-slate-100">

    <nav class="border-b border-slate-700 bg-slate-800 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2 text-emerald-400">
            <i data-lucide="shield-check" class="w-6 h-6"></i>
            <span class="text-xl font-bold">LogiTech Admin</span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm text-slate-400">Administrator</span>
            <a href="/logout" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm font-medium transition">Logout</a>
        </div>
    </nav>

    <div class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1">
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-lg">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-blue-400"></i> Add Facility
                </h2>
                
                <form action="/admin/add_warehouse" method="POST" class="space-y-4" id="addWhForm">
                    <div>
                        <label class="block text-xs text-slate-400 uppercase mb-1">Warehouse Name</label>
                        <input type="text" name="name" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-blue-500 outline-none placeholder-slate-600" placeholder="e.g. Central Hub A">
                    </div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 uppercase mb-1">Full Address</label>
                        <div class="flex flex-col gap-2">
                            <textarea id="whAddress" name="address" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-blue-500 outline-none placeholder-slate-600" rows="2" placeholder="e.g. 12 Gandhi Road, Salem"></textarea>
                            
                            <button type="button" onclick="verifyAdminLocation()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-bold uppercase tracking-wider transition">
                                Verify Location Coordinates
                            </button>
                        </div>
                        <p id="geoStatus" class="text-xs text-slate-500 mt-2 h-4"></p>
                    </div>

                    <div id="adminMap" class="h-48 w-full bg-slate-700 rounded-lg hidden border border-slate-600 mt-2"></div>

                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="block text-xs text-slate-400 uppercase mb-1">Region</label>
                            <select name="region" class="w-full bg-slate-900 border border-slate-700 rounded p-2 outline-none">
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 uppercase mb-1">Capacity (kg)</label>
                            <input type="number" name="capacity" required class="w-full bg-slate-900 border border-slate-700 rounded p-2 focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <div class="pt-2 border-t border-slate-700 mt-2">
                        <label class="block text-xs text-slate-400 uppercase mb-1">Manager Details</label>
                        <input type="text" name="manager" placeholder="Manager Name" class="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-2 placeholder-slate-600">
                        <input type="text" name="contact" placeholder="Contact Number" class="w-full bg-slate-900 border border-slate-700 rounded p-2 placeholder-slate-600">
                    </div>

                    <input type="hidden" name="lat" id="lat">
                    <input type="hidden" name="lng" id="lng">

                    <button type="submit" id="submitBtn" disabled class="w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-700 disabled:text-slate-500 text-white font-bold py-3 rounded transition mt-2">
                        Register Warehouse
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <h2 class="text-2xl font-bold flex items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-7 h-7 text-emerald-400"></i> 
                Network Capacity Monitor
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for wh in warehouses %}
                <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4 relative z-10">
                        <div>
                            <h3 class="font-bold text-lg text-white">{{ wh.name }}</h3>
                            <p class="text-slate-400 text-sm flex items-center gap-1">
                                <i data-lucide="map-pin" class="w-3 h-3"></i> 
                                {{ wh.region }}
                            </p>
                        </div>
                        <span class="text-2xl font-mono font-bold {{ 'text-red-400' if wh.percent > 90 else 'text-emerald-400' }}">
                            {{ wh.percent }}%
                        </span>
                    </div>

                    <div class="w-full bg-slate-900 rounded-full h-4 mb-2 relative z-10 border border-slate-700">
                        <div class="{{ wh.color }} h-4 rounded-full transition-all duration-1000" style="width: {{ wh.percent }}%"></div>
                    </div>

                    <div class="flex justify-between text-xs text-slate-400 relative z-10 font-mono">
                        <span>Load: {{ wh.current_load }} kg</span>
                        <span>Cap: {{ wh.capacity }} kg</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let mapInstance = null;
        let marker = null;

        async function verifyAdminLocation() {
            const address = document.getElementById('whAddress').value;
            const status = document.getElementById('geoStatus');
            const submitBtn = document.getElementById('submitBtn');
            const mapDiv = document.getElementById('adminMap');
            
            if(!address) {
                status.innerHTML = "<span class='text-red-400'>Enter an address first.</span>";
                return;
            }

            status.innerHTML = "<span class='text-blue-400 animate-pulse'>Locating...</span>";

            try {
                // Call the backend proxy
                const response = await fetch(`/api/geocode?address=${encodeURIComponent(address)}`);
                const data = await response.json();

                if(data.success) {
                    // Fill hidden inputs
                    document.getElementById('lat').value = data.lat;
                    document.getElementById('lng').value = data.lon;
                    
                    status.innerHTML = `<span class='text-emerald-400 font-bold'>✓ Found: ${data.lat}, ${data.lon}</span>`;
                    
                    // Enable the submit button
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-slate-700', 'text-slate-500');
                    submitBtn.classList.add('bg-emerald-600', 'text-white');

                    // ⚠️ ADDED: Show Map
                    mapDiv.classList.remove('hidden');
                    if(!mapInstance) {
                        mapInstance = L.map('adminMap').setView([data.lat, data.lon], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                    } else {
                        mapInstance.setView([data.lat, data.lon], 13);
                    }
                    if(marker) mapInstance.removeLayer(marker);
                    marker = L.marker([data.lat, data.lon]).addTo(mapInstance);

                } else {
                    status.innerHTML = "<span class='text-red-400'>Address not found. Try adding City/State.</span>";
                    submitBtn.disabled = true;
                    mapDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error(error);
                status.innerHTML = "<span class='text-red-400'>Server connection failed.</span>";
            }
        }
    </script>
</body>
</html>